# Read in packages
```{r}
require(ggplot2)
require(plyr)
require(lubridate)
require(dplyr)
require(sp)
require(maptools)
require(ggmap)
require(ggplot2)
require(reshape2)
require(rgdal)
require(raster)
require(rgeos)
require(PBSmapping)
require(gdistance)
require(grid)
require(gridExtra)
```

### plotting Norway data
```{r}
adult <- read.table("./results_scen1wild1/adult.txt", header=TRUE)
herit.FW <- read.table("./results_scen1wild1/heritabilityFreshwater.txt", header=TRUE)
herit.S <- read.table("./results_scen1wild1/heritabilitySea.txt", header=TRUE)
smolts <- read.table("./results_scen1wild1/smolts.txt", header=TRUE)
embryo <- read.table("./results_scen1wild1/embryo.txt", header=TRUE)
parr0 <- read.table("./results_scen1wild1/parr0.txt", header=TRUE)
parr1 <- read.table("./results_scen1wild1/parr1.txt", header=TRUE)
parr2 <- read.table("./results_scen1wild1/parr2.txt", header=TRUE)
spawners <- read.table("./results_scen1wild1/spawners.txt", fill=TRUE, colClasses = "character")
colnames(spawners) <- spawners[1,]
spawners <- spawners[2:399,]

##fry <- read.table("./results_scen1wild1/fry.txt", header=TRUE)

juv <- rbind(parr0, parr1, parr2)
juv$YC <- c(0,0,1,1,2,2)

# Can I replicate Figure 2 in the IBSEM paper?

plot1 <- plot(1, embryo$density)
plot2 <- plot(juv$YC, juv$density)


head(adult)

p0 <- ggplot() + geom_line(data=adult[1:250,], aes(month, sw0), colour="red") +
  geom_point(data=adult[1:250,], aes(month, sw0), colour="red") +
  theme_bw()
p1 <- ggplot() + geom_line(data=adult[1:250,], aes(month, sw1), colour="orange") +
  geom_point(data=adult[1:250,], aes(month, sw1), colour="orange") +
  theme_bw()
p2 <- ggplot() + geom_line(data=adult[1:250,], aes(month, sw2), colour="green") +
  geom_point(data=adult[1:250,], aes(month, sw2), colour="green") +
  theme_bw()
p3 <- ggplot() + geom_line(data=adult[1:250,], aes(month, sw3), colour="blue") +
  geom_point(data=adult[1:250,], aes(month, sw3), colour="blue") +  
  theme_bw()

grid.arrange(p0,p1,p2,p3, nrow=4)

ggplot() + geom_line(data=adult[1:250,], aes(month, total)) +
  geom_point(data=adult[1:250,], aes(month, total)) +
  theme_bw()

adult$month.adj <- adult$month%%12

ggplot() + 
  geom_boxplot(data=adult, aes(month.adj, popSize, group=month.adj)) +
  theme_bw()

sept <- subset(adult, month.adj == 9)
mean(sept$sw0)
mean(sept$sw1)
mean(sept$sw2)
mean(sept$sw3)
sd(sept$sw0)
sd(sept$sw1)
sd(sept$sw2)
sd(sept$sw3)


spawners$month.adj <- as.numeric(spawners$month)%%12
octob <- subset(spawners, month.adj==9)
colnames(octob)[9:12] <- c("sw0", "sw1", "sw2", "sw3")
mean(as.numeric(octob$sw3))

variables <- data.frame(vars = c(colnames(adult), colnames(smolts), colnames(parr0), colnames(parr1), colnames(parr2), colnames(spawners), colnames(embryo), colnames(herit.FW), colnames(herit.S)))


pAdult <- read.table("C:/Users/keyserf/Desktop/salmonIBM/Install/src/runFiles/parameters/adultParameters.txt")
```


### read in environmental data
```{r}
require(raster)
require(ncdf4)

temps <- nc_open("C:/Users/keyserf/Downloads/sst.mnmean.v3.nc")
temps <- raster(temps)
lon <- ncvar_get(temps, "lon")
nlon <- dim(lon)
lat <- ncvar_get(temps, "lat")
nlat <- dim(lat)
time <- ncvar_get(temps, "time")
ntime <- dim(time)
meas <- ncvar_get(temps, "sst")

m <- 1
tmp.slice <- meas[, , m]

plot(raster(tmp.slice))

print(temps)

df <- expand.grid(lon, lat, time)
meas.vec <- as.vector(meas)
df <- data.frame(cbind(df, meas.vec))
names(df) <- c("lon", "lat", "dayssince", "temp")

test <- ddply(.data=df, .(lon, lat),
              summarize,
              mnmean=mean(temp, na.rm=TRUE))

ggplot() + geom_point(data=test, aes(lon, lat, colour=mnmean)) +
  geom_rect(data=test, aes(xmin=290, xmax=310, ymin=45, ymax=60), fill=NA, colour="white")

df_atl <- subset(df, lon >290 & lon <310 & lat>45 & lat < 55 & is.na(temp)==FALSE)

head(df_atl)
df_atl$date <- ymd("1800-01-01") + days(df_atl$dayssince)
df_atl$month <- month(df_atl$date)
df_atl$year <- year(df_atl$date)
df_atl <- subset(df_atl, year > 1985)

mnmean <- ddply(.data=df_atl, .(month),
                summarize,
                mntemp = mean(temp))

ggplot() + geom_point(data=mnmean, aes(month, mntemp)) + theme_bw()

### mnmean contains monthly 30-year averaged sea temperatures.

### next steps: need river temperature data
```



### analyse 50-year salmon data to get parameters
### read in table
```{r}
## only some of the data
ian <- read.table("C:/Users/keyserf/Documents/Data/All Biochar NET and RR Oct 2013.txt", header=TRUE)
names(ian)

ian[,1:20] <- apply(ian[,1:20], 2, function(x) as.numeric(as.character(x)))


## all the data
salmon <- read.csv("C:/Users/keyserf/Documents/Data/All Biochar Oct 2013.csv", header=TRUE)
names(salmon)

str(salmon)
unique(salmon$SEX)

## correct the year column
salmon$year.adj <- as.numeric(ifelse(salmon$YEAR < 10, paste0(200, salmon$YEAR), ifelse(salmon$YEAR %in% c(10,11,12), paste0(20, salmon$YEAR), salmon$YEAR)))

salmon[,5:28] <- apply(salmon[,5:28], 2, function(x) as.numeric(as.character(x)))

## look at sampling timing
ggplot() + geom_histogram(data=salmon, aes(MO), colour="black", fill="white") + scale_x_continuous(breaks=seq(0, 13,1)) + theme_bw() 


## format dates
salmon$DATE <- ymd(paste0(salmon$year.adj,"-", salmon$MO,"-", salmon$DY))
salmon$dayssince <- salmon$DATE - ymd("1954-01-01")
salmon$doy <- salmon$DATE - ymd(paste0(salmon$year.adj, "-", 1, "-", 1))

ggplot() + geom_histogram(data=salmon[salmon$RA>1,], aes(MO, fill=as.factor(RA)), binwidth=1, colour="black", position=position_dodge()) + scale_x_continuous(breaks=seq(0, 12,1)) + theme_bw() 

### spring parr = 1
### spring smolts = 2
### 1 summer smolts = 3

# RA = river age?
# SA = sea age?

### need to separate by season due to summer growth
salmon$season <- ifelse(salmon$MO %in% c(4,5,6), "spring", ifelse(salmon$MO %in% c(7,8), "summer", ifelse(salmon$MO %in% c(9,10,11), "fall", NA)))

### only look at fish caught as smolts
smolts <- subset(salmon, RA %in% c(2,3,4,5) & is.na(SA)==TRUE)

smolts$season <- factor(smolts$season, levels=c("spring", "summer", "fall"))

### plot smolt lengths against year and by nyears in river 
ggplot() + 
  geom_point(data=smolts[smolts$season=="spring" & is.na(smolts$season)==FALSE,], aes(year.adj, FL)) + 
  facet_grid(RA~.) +
  theme_bw() +
  geom_smooth(data=smolts[smolts$season=="spring" & is.na(smolts$season)==FALSE,], aes(year.adj, FL), method="lm") + 
  ylab("Fork length (mm)") 

model1 <- lm(data=smolts[which(smolts$RA==2 & smolts$season=="spring"),], FL~year.adj,na.action = na.exclude)
summary(model1)

model2 <- lm(data=smolts[which(smolts$RA==3 & smolts$season=="spring"),], FL~year.adj)
summary(model2)

model3 <- lm(data=smolts[which(smolts$RA==4 & smolts$season=="spring"),], FL~year.adj)
summary(model3)

model4 <- lm(data=smolts[which(smolts$RA==5 & smolts$season=="spring"),], FL~year.adj)
summary(model4)


mod1byyear <- cbind(resid(model1), smolts[which(smolts$RA==2 & smolts$season=="spring"),])

View(mod1byyear[which(mod1byyear$year.adj == 1995), ])
View(mod1byyear[which(mod1byyear$year.adj == 1968), ])

colnames(mod1byyear)[1] <- "resid"

aggregate(resid ~ year.adj, data = mod1byyear, FUN = mean)

plot(aggregate(resid ~ year.adj, data = mod1byyear, FUN = mean))

allsmolts <- subset(salmon, RA %in% c(2,3,4,5) & TA <10 & is.na(TA)==FALSE & season=="spring")

grid1 <- ggplot() + 
  geom_point(data=allsmolts[allsmolts$season=="spring" & is.na(allsmolts$season)==FALSE,], aes(year.adj, FL)) + 
  facet_grid(RA~TA) +
  theme_bw() +
  geom_smooth(data=allsmolts[allsmolts$season=="spring" & is.na(allsmolts$season)==FALSE,], aes(year.adj, FL), method="lm") + 
  ylab("Fork length (mm)") 


models <- ddply(.data=allsmolts, .(RA, TA),
                function(x)
                coef(lm(data=x, FL ~ year.adj)))

models_rsq <- ddply(.data=allsmolts, .(RA, TA),
                function(x)
                summary(lm(data=x, FL ~ year.adj))$r.squared)

models_pval <- ddply(.data=allsmolts, .(RA, TA),
                function(x)
                anova(lm(data=x, FL ~ year.adj))$'Pr(>F)'[1])

models <- join(models, models_rsq, type="left")
models$year<- 2011
models$FL <- 1250

grid1 <- grid1 + geom_text(data=models, aes(year, FL, label=paste0("slope: ", round(year.adj,3), "\n", "Rsq: ", round(V1,3))), size=3, hjust=1) 
grid1


ggplot() + geom_point(data=allsmolts, aes(TA, FL)) + geom_smooth(data=allsmolts, aes(TA, FL), method="lm")
lm1 <- lm(data=allsmolts, FL ~ TA)
summary(lm1)
# FL = -220.8338 + 131.2867*TA

allsmolts$predsmoltlength <- -220.8338 + 131.2867*(allsmolts$RA)

ggplot() + geom_point(data=allsmolts, aes(RA, predsmoltlength))

models_year <- ddply(.data=allsmolts, .(year.adj),
                function(x)
                coef(lm(data=x, FL ~ TA)))
names(models_year) <- c("year.adj", "Intercept", "Slope")

allsmolts <- join(allsmolts, models_year, type="left")

allsmolts$predsmoltlength <- allsmolts$Intercept + (allsmolts$Slope*allsmolts$RA)

ggplot() + geom_point(data=allsmolts, aes(year.adj, predsmoltlength)) + 
  facet_wrap(~RA) + 
  geom_smooth(data=allsmolts, aes(year.adj, predsmoltlength), method="lm")



##############################

## Calculating natural mortality
agestr <- ddply(.data=salmon[salmon$SEX %in% c(1,2),], .(TA, SEX),
                summarize,
                total = length(FL))

ggplot() + geom_point(data=agestr[is.na(agestr$TA)==FALSE & agestr$TA >3,], aes(TA, log(total))) + facet_wrap(~SEX) +
  geom_smooth(data=agestr[is.na(agestr$TA)==FALSE & agestr$TA >3,], aes(TA, log(total)), method="lm") +
  theme_classic() + theme(panel.border=element_rect(colour="black", fill=NA))
# total mortality for sex 1 = -1.43792 | for sex 2 = -1.6628
# error for sex 1 = 0.09739 | for sex 2 = 0.1194

# exp(-1.43792) = 0.2374211 survival per year


model1 <- lm(data=agestr[is.na(agestr$TA)==FALSE & agestr$TA >3 & agestr$SEX==1,], log(total)~TA) 
summary(model1)
model2 <- lm(data=agestr[is.na(agestr$TA)==FALSE & agestr$TA >3 & agestr$SEX==2,], log(total)~TA) 
summary(model2)

table(ian$LS)
#smolting probability = LS 3 / LS 2
966/5129 
# = 0.1883

#maturation probability = number of mature 

max(table(salmon$AREA))
site <- table(salmon$AREA)

site <- melt(site)
site <- subset(site, value> 10000)

unique(site$Var1)

bigsites <- subset(salmon, AREA %in% c("70779", "361335", "490519"))
ggplot() + geom_histogram(data=bigsites, aes(year.adj), binwidth=1, colour="black", fill=NA) + facet_wrap(~AREA) + theme_bw()

ddply(.data= ddply(.data=bigsites, .(AREA, year.adj),
      summarize,
      total = length(FL)),
      .(AREA),
      summarize,
      smallest = min(total),
      largest = max(total))

### let's only look at site area 490519 because it has somewhat consistent sampling effort

bestsite <- subset(salmon, AREA == 490519)
bestsiteTA <- ddply(.data=bestsite, .(TA),
                    summarize,
                    total=length(FL))

ggplot() + geom_point(data=bestsiteTA[bestsiteTA$TA>3,], aes(TA, log(total))) + 
  geom_smooth(data=bestsiteTA[bestsiteTA$TA>3,], aes(TA, log(total)), method="lm") + 
  theme_bw()

```

### try Piou and Prevost IBASAM package
```{r}
## see github page: https://github.com/Ibasam/IBASAM

require(Ibasam)
install.packages("Ibasam")
update.packages(checkBuilt=TRUE, ask=FALSE)

library(devtools)
install("C:/Users/keyserf/Documents/Data/Ibasam/Compiled/Ibasam_2.1.0.zip")
